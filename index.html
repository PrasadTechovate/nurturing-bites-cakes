<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Fair Staff Management Calendar - 2026</title>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
* { box-sizing: border-box; }
body{font-family:'Segoe UI', Arial, sans-serif;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);padding:20px;min-height:100vh}
.container{max-width:1400px;margin:0 auto;background:white;border-radius:20px;padding:30px;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
h1{text-align:center;color:#333;margin-bottom:10px;font-size:2.2em}
.subtitle{text-align:center;color:#666;margin-bottom:30px;font-size:1.1em}
.tabs{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:25px;background:#f5f5f5;padding:10px;border-radius:15px}
.tab{padding:12px 24px;background:white;border-radius:10px;cursor:pointer;font-weight:600;transition:all 0.3s;border:2px solid transparent}
.tab:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.1)}
.tab.active{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;border-color:#667eea}
.calendar-container{margin-bottom:40px}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:12px;margin-bottom:25px}
.header{background:linear-gradient(135deg, #2c3e50 0%, #34495e 100%);color:white;padding:15px;text-align:center;border-radius:10px;font-weight:600;font-size:1.1em}
.cell{background:white;border-radius:12px;min-height:140px;padding:15px;box-shadow:0 5px 15px rgba(0,0,0,0.08);position:relative;display:flex;flex-direction:column;transition:all 0.3s;border:2px solid transparent}
.cell:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,0.15)}
.date{font-weight:700;font-size:18px;margin-bottom:8px;color:#2c3e50}
.day-name{font-size:13px;color:#7f8c8d;margin-left:6px;font-weight:500}
.sunday{background:linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%) !important;color:white}
.sunday .date{color:white}
.sunday .day-name{color:rgba(255,255,255,0.9)}
.today{border:3px solid #4CAF50 !important;background:#f1f8e9}
.past-date{background:#f8f9fa;opacity:0.8}
.off-staff{color:#d32f2f;font-weight:600;margin:6px 0;padding:8px 10px;background:#ffebee;border-radius:8px;font-size:14px;border-left:4px solid #d32f2f}
.stock-incharge{color:#1565c0;font-weight:600;margin:4px 0;font-size:13.5px}
.stock-badge{display:inline-block;background:linear-gradient(135deg, #1565c0 0%, #1976d2 100%);color:white;padding:3px 10px;border-radius:15px;font-size:11px;margin-left:6px;font-weight:600}
.dashboard{margin:40px 0}
h2{color:#2c3e50;margin-top:35px;border-bottom:3px solid #667eea;padding-bottom:12px;font-size:1.8em}
h3{color:#34495e;margin-top:30px;border-bottom:2px solid #bdc3c7;padding-bottom:10px;font-size:1.4em}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:40px}
.stat-card{background:white;border-radius:15px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,0.1);position:relative;overflow:hidden;border:1px solid #e0e0e0}
.stat-card::before{content:'';position:absolute;top:0;left:0;width:6px;height:100%;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%)}
.stat-title{font-weight:600;color:#7f8c8d;font-size:15px;margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px}
.stat-value{font-size:32px;font-weight:700;color:#2c3e50;margin-bottom:8px}
.stat-details{margin-top:15px;font-size:14px;color:#666}
.charts-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:25px;margin-top:25px}
.chart-box{background:white;border-radius:15px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,0.1);border:1px solid #e0e0e0}
.controls{display:flex;gap:15px;margin-bottom:30px;flex-wrap:wrap;background:#f8f9fa;padding:20px;border-radius:15px}
.view-controls{display:flex;gap:10px;background:white;padding:10px;border-radius:10px}
.view-btn{padding:12px 25px;border:2px solid #667eea;background:white;color:#667eea;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s}
.view-btn:hover{background:#f0f2ff}
.view-btn.active{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white}
.data-table{width:100%;border-collapse:separate;border-spacing:0;margin-top:25px;border-radius:15px;overflow:hidden;box-shadow:0 5px 20px rgba(0,0,0,0.1)}
.data-table th{background:linear-gradient(135deg, #2c3e50 0%, #34495e 100%);color:white;padding:18px;text-align:left;font-weight:600;font-size:15px}
.data-table td{border:1px solid #e0e0e0;padding:15px;background:white}
.data-table tr:nth-child(even) td{background:#f8f9fa}
.data-table tr:hover td{background:#e3f2fd}
.export-btn{padding:12px 25px;background:linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s;margin:5px}
.export-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(76, 175, 80, 0.4)}
.filter-container{display:flex;gap:15px;flex-wrap:wrap;background:white;padding:15px;border-radius:10px}
.filter-select{padding:10px 20px;border:2px solid #bdc3c7;border-radius:8px;font-size:14px;min-width:180px}
.legend{display:flex;gap:20px;flex-wrap:wrap;margin:20px 0;background:white;padding:20px;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,0.08)}
.legend-item{display:flex;align-items:center;gap:10px;font-size:14px;font-weight:500}
.legend-color{width:20px;height:20px;border-radius:5px}
.fairness-meter{height:12px;background:#ecf0f1;border-radius:6px;margin-top:10px;overflow:hidden}
.fairness-fill{height:100%;transition:width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1)}
.status-indicator{display:inline-block;padding:5px 15px;border-radius:20px;font-size:12px;font-weight:600;margin-left:10px}

/* List View */
.list-view-container{display:none;background:white;border-radius:15px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,0.1);margin-top:20px}
.list-day-item{border-bottom:2px solid #f0f0f0;padding:20px 0;transition:all 0.3s}
.list-day-item:hover{background:#f8f9fa;padding-left:10px}
.list-day-item:last-child{border-bottom:none}
.list-day-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.list-date{font-weight:700;font-size:18px;color:#2c3e50}
.list-day{color:#7f8c8d;font-size:15px;margin-left:15px}
.list-sunday .list-date{color:#d32f2f}
.list-today{border-left:6px solid #4CAF50;padding-left:15px;background:#f1f8e9}
.list-past{opacity:0.7}
.list-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-top:15px}
.list-detail-item{padding:15px;background:#f8f9fa;border-radius:10px;border:1px solid #e0e0e0}
.list-detail-label{font-weight:600;color:#7f8c8d;font-size:12px;margin-bottom:8px;text-transform:uppercase}
.list-detail-value{font-size:15px}
.list-off{color:#d32f2f}
.list-stock{color:#1565c0}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.fade-in {
    animation: fadeIn 0.6s ease-out;
}

.loading {
    text-align: center;
    padding: 40px;
    font-size: 16px;
    color: #666;
}
.d-none{
    display:none;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .calendar { grid-template-columns: repeat(1, 1fr); }
    .header { display: none; }
    .cell { min-height: auto; }
    .controls { flex-direction: column; }
    .filter-container { flex-direction: column; }
    .legend { flex-direction: column; }
}
</style>
</head>
<body>

<div class="container fade-in">
    <h1>üè¢ Staff Management Dashboard 2026</h1>
    <p class="subtitle">Fair Weekly Off & Stock Duty Distribution System</p>
        <div class="controls">
        <div class="view-controls">
            <button class="view-btn active" data-view="calendar">üìÖ Calendar View</button>
            <button class="view-btn" data-view="list">üìã List View</button>
        </div>
        
        <div class="filter-container d-none">
            <select id="filterStaff" class="filter-select">
                <option value="">All Staff Members</option>
            </select>
            <select id="filterMonth" class="filter-select">
                <option value="">Filter by Month</option>
            </select>
        </div>
    </div>
    
    <div class="legend">
        <div class="legend-item"><div class="legend-color" style="background:#ffebee"></div>Weekly Off Day</div>
        <div class="legend-item"><div class="legend-color" style="background:#e3f2fd"></div>Stock Incharge</div>
        <div class="legend-item"><div class="legend-color" style="background:#f1f8e9"></div>Today's Date</div>
        <div class="legend-item"><div class="legend-color" style="background:#ff6b6b"></div>Sunday</div>
        <div class="legend-item"><div class="legend-color" style="background:#f8f9fa"></div>Completed Date</div>
    </div>
    
    <div class="tabs" id="tabs"></div>
    

    
    <div class="calendar-container">
        <div class="calendar" id="calendar"></div>
        <div class="list-view-container" id="listView"></div>
    </div>
    
    <div class="dashboard">
        <h2>üìä Monthly Distribution Analysis</h2>
        <div class="stats-grid" id="statsGrid"></div>
        
        <h3>üìà Performance Analytics</h3>
        <div class="charts-container">
            <div class="chart-box">
                <canvas id="offsChart"></canvas>
            </div>
            <div class="chart-box">
                <canvas id="stockChart"></canvas>
            </div>
            <div class="chart-box">
                <canvas id="workloadChart"></canvas>
            </div>
        </div>
        
        <h3>‚öñÔ∏è Fairness & Balance Metrics</h3>
        <div id="fairnessMetrics"></div>
        
        <h3>üë• Staff Performance Report</h3>
        <div class="controls">
            <button class="export-btn" onclick="exportToCSV()">üì• Export CSV Report</button>
            <button class="export-btn" onclick="exportToPDF()">üìÑ Generate PDF</button>
            <button class="export-btn" onclick="window.print()">üñ®Ô∏è Print Report</button>
        </div>
        <div id="performanceReport" class="loading">
            Generating performance report...
        </div>
    </div>
</div>

<script>
// ====== CONFIGURATION ======
const staff = [
    { id: 1, name: "Vanitha", role: "Operator" },
    { id: 2, name: "Ram", role: "Operator" },
    { id: 3, name: "Hareesh", role: "Operator" },
    { id: 4, name: "Jannat", role: "Operator" },
    { id: 5, name: "Chandhan", role: "Operator" },
    { id: 6, name: "Kalyan", role: "Operator" },
    { id: 7, name: "Mariya", role: "Operator" },
    { id: 8, name: "Raju", role: "Operator" }
];

const months = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
];

const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
const shortDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

// Start from first Monday of 2026
const startDate = new Date("2026-01-05");
const today = new Date();
today.setHours(0, 0, 0, 0);

let currentView = 'calendar';
let currentMonth = today.getMonth();
let currentYear = 2026;

// ====== FAIR DISTRIBUTION SYSTEM ======
class FairDistributionSystem {
    constructor() {
        this.staffStats = {};
        this.stockHistory = {};
        this.offHistory = {};
        this.monthlyData = {};
        this.initialize();
    }
    
    initialize() {
        staff.forEach(s => {
            this.staffStats[s.name] = {
                totalOffs: 0,
                sundayOffs: 0,
                stockDuties: 0,
                workingDays: 0,
                consecutiveWorkDays: 0,
                lastOffDate: null,
                lastStockDate: null
            };
            this.stockHistory[s.name] = [];
            this.offHistory[s.name] = [];
        });
    }
    
    // Fair weekly off distribution (3-4 offs per month)
    getWeeklyOff(date) {
        const dayOfWeek = date.getDay();
        const dateStr = date.toISOString().split('T')[0];
        
        if (dayOfWeek === 0) {
            // Sunday: Rotate through all staff
            const weekNumber = Math.floor((date - startDate) / (7 * 24 * 60 * 60 * 1000));
            const staffIndex = weekNumber % staff.length;
            return [staff[staffIndex].name];
        } else {
            // Weekdays: Ensure each staff gets 3-4 offs per month
            const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
            const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            const daysInMonth = monthEnd.getDate();
            
            // Get staff who haven't reached 4 offs and had off at least 3 days ago
            const eligibleStaff = staff.filter(s => {
                const stats = this.staffStats[s.name];
                const targetOffs = 4; // Aim for 4 offs per month
                
                // Check if staff has reached target
                if (stats.totalOffs >= targetOffs) return false;
                
                // Check days since last off
                if (stats.lastOffDate) {
                    const daysSince = Math.floor((date - stats.lastOffDate) / (24 * 60 * 60 * 1000));
                    if (daysSince < 3) return false; // Minimum 3 days between offs
                }
                
                return true;
            });
            
            if (eligibleStaff.length > 0) {
                // Sort by: 1) Fewest offs, 2) Most days since last off
                eligibleStaff.sort((a, b) => {
                    const aOffs = this.staffStats[a.name].totalOffs;
                    const bOffs = this.staffStats[b.name].totalOffs;
                    if (aOffs !== bOffs) return aOffs - bOffs;
                    
                    const aLast = this.staffStats[a.name].lastOffDate;
                    const bLast = this.staffStats[b.name].lastOffDate;
                    const aDays = aLast ? Math.floor((date - aLast) / (24 * 60 * 60 * 1000)) : 999;
                    const bDays = bLast ? Math.floor((date - bLast) / (24 * 60 * 60 * 1000)) : 999;
                    return bDays - aDays;
                });
                
                return [eligibleStaff[0].name];
            }
            
            // If no eligible staff, pick one with most days since last off
            const allStaff = [...staff].sort((a, b) => {
                const aLast = this.staffStats[a.name].lastOffDate;
                const bLast = this.staffStats[b.name].lastOffDate;
                const aDays = aLast ? Math.floor((date - aLast) / (24 * 60 * 60 * 1000)) : 999;
                const bDays = bLast ? Math.floor((date - bLast) / (24 * 60 * 60 * 1000)) : 999;
                return bDays - aDays;
            });
            
            return [allStaff[0].name];
        }
    }
    
    // Fair stock duty distribution
    getStockIncharge(date, offStaff) {
        const activeStaff = staff.filter(s => !offStaff.includes(s.name)).map(s => s.name);
        
        if (activeStaff.length <= 2) {
            return activeStaff;
        }
        
        // Sort by: 1) Fewest stock duties, 2) Most days since last stock duty
        const sortedStaff = activeStaff.sort((a, b) => {
            const aDuties = this.staffStats[a].stockDuties;
            const bDuties = this.staffStats[b].stockDuties;
            if (aDuties !== bDuties) return aDuties - bDuties;
            
            const aLast = this.staffStats[a].lastStockDate;
            const bLast = this.staffStats[b].lastStockDate;
            const aDays = aLast ? Math.floor((date - aLast) / (24 * 60 * 60 * 1000)) : 999;
            const bDays = bLast ? Math.floor((date - bLast) / (24 * 60 * 60 * 1000)) : 999;
            return bDays - aDays;
        });
        
        return sortedStaff.slice(0, 2);
    }
    
    updateStats(date, offStaff, stockIncharge) {
        const isSunday = date.getDay() === 0;
        
        // Update off stats
        offStaff.forEach(name => {
            this.staffStats[name].totalOffs++;
            if (isSunday) this.staffStats[name].sundayOffs++;
            this.staffStats[name].lastOffDate = date;
            this.offHistory[name].push(date.toISOString().split('T')[0]);
            this.staffStats[name].consecutiveWorkDays = 0;
        });
        
        // Update stock stats
        stockIncharge.forEach(name => {
            this.staffStats[name].stockDuties++;
            this.staffStats[name].lastStockDate = date;
            this.stockHistory[name].push(date.toISOString().split('T')[0]);
        });
        
        // Update working days for active staff
        const activeStaff = staff.filter(s => !offStaff.includes(s.name));
        activeStaff.forEach(s => {
            this.staffStats[s.name].workingDays++;
            this.staffStats[s.name].consecutiveWorkDays++;
        });
    }
    
    resetForNewMonth() {
        staff.forEach(s => {
            this.staffStats[s.name].totalOffs = 0;
            this.staffStats[s.name].sundayOffs = 0;
            this.staffStats[s.name].stockDuties = 0;
            this.staffStats[s.name].workingDays = 0;
            this.staffStats[s.name].consecutiveWorkDays = 0;
            this.staffStats[s.name].lastOffDate = null;
            this.staffStats[s.name].lastStockDate = null;
        });
        this.monthlyData = {};
    }
}

// Initialize distribution system
const distributionSystem = new FairDistributionSystem();

// ====== RENDER FUNCTIONS ======
function renderCalendar(month) {
    const $cal = $("#calendar");
    $cal.empty();
    
    // Add headers
    shortDays.forEach(day => {
        $cal.append(`<div class="header">${day}</div>`);
    });
    
    const first = new Date(currentYear, month, 1);
    const last = new Date(currentYear, month + 1, 0);
    const totalDays = last.getDate();
    
    // Empty cells for days before month start
    for (let i = 0; i < first.getDay(); i++) {
        $cal.append(`<div class="cell empty"></div>`);
    }
    
    // Reset for new month
    distributionSystem.resetForNewMonth();
    
    // Generate calendar
    for (let d = 1; d <= totalDays; d++) {
        const date = new Date(currentYear, month, d);
        const isSunday = date.getDay() === 0;
        const isToday = date.getTime() === today.getTime();
        const isPast = date < today;
        const dateStr = date.toISOString().split('T')[0];
        
        // Get assignments
        const offStaff = distributionSystem.getWeeklyOff(date);
        const stockIncharge = distributionSystem.getStockIncharge(date, offStaff);
        
        // Update statistics
        distributionSystem.updateStats(date, offStaff, stockIncharge);
        
        // Store monthly data
        distributionSystem.monthlyData[dateStr] = {
            date,
            offStaff,
            stockIncharge,
            isSunday,
            isToday,
            isPast
        };
        
        // Create cell
        let cellClass = "cell fade-in";
        if (isSunday) cellClass += " sunday";
        if (isToday) cellClass += " today";
        if (isPast) cellClass += " past-date";
        
        $cal.append(`
            <div class="${cellClass}">
                <div class="date">
                    ${d}
                    <span class="day-name">${shortDays[date.getDay()]}</span>
                    ${isSunday ? 'üéâ' : ''}
                </div>
                ${offStaff.length > 0 ? `
                    <div class="off-staff">
                        üèñÔ∏è OFF: ${offStaff.join(', ')}
                    </div>
                ` : ''}
                <div class="stock-incharge">
                    üì¶ Stock: ${stockIncharge.map(name => 
                        `<span>${name}<span class="stock-badge">IN</span></span>`
                    ).join(', ')}
                </div>
                <div style="margin-top:auto; padding-top:10px; font-size:12px; color:#7f8c8d">
                    üë• Active: ${staff.length - offStaff.length} staff
                </div>
            </div>
        `);
    }
    
    // Render analytics
    renderStatistics();
    renderFairnessMetrics();
    renderCharts();
    renderPerformanceReport();
}

function renderListView() {
    const $list = $("#listView");
    $list.empty();
    
    const first = new Date(currentYear, currentMonth, 1);
    const last = new Date(currentYear, currentMonth + 1, 0);
    
    let html = '<div class="list-view-content">';
    
    for (let d = 1; d <= last.getDate(); d++) {
        const date = new Date(currentYear, currentMonth, d);
        const isSunday = date.getDay() === 0;
        const isToday = date.getTime() === today.getTime();
        const isPast = date < today;
        const dateStr = date.toISOString().split('T')[0];
        
        // Get data from monthly storage
        const dayData = distributionSystem.monthlyData[dateStr];
        if (!dayData) continue;
        
        const { offStaff, stockIncharge } = dayData;
        const activeStaff = staff.filter(s => !offStaff.includes(s.name)).map(s => s.name);
        
        let itemClass = "list-day-item";
        if (isSunday) itemClass += " list-sunday";
        if (isToday) itemClass += " list-today";
        if (isPast) itemClass += " list-past";
        
        html += `
            <div class="${itemClass}">
                <div class="list-day-header">
                    <div>
                        <span class="list-date">${date.getDate()} ${months[date.getMonth()]}</span>
                        <span class="list-day">${daysOfWeek[date.getDay()]}</span>
                    </div>
                    <div style="color:#7f8c8d; font-size:13px">
                        ${isPast ? '‚úÖ Completed' : 'üìÖ Upcoming'}
                    </div>
                </div>
                <div class="list-details">
                    <div class="list-detail-item">
                        <div class="list-detail-label">Weekly Off</div>
                        <div class="list-detail-value list-off">
                            ${offStaff.length > 0 ? `üèñÔ∏è ${offStaff.join(', ')}` : 'All staff working'}
                        </div>
                    </div>
                    <div class="list-detail-item">
                        <div class="list-detail-label">Stock Incharge</div>
                        <div class="list-detail-value list-stock">
                            üì¶ ${stockIncharge.join(', ')}
                        </div>
                    </div>
                    <div class="list-detail-item">
                        <div class="list-detail-label">Active Staff</div>
                        <div class="list-detail-value">
                            üë• ${activeStaff.length} staff working
                        </div>
                    </div>
                    <div class="list-detail-item">
                        <div class="list-detail-label">Staff on Duty</div>
                        <div class="list-detail-value" style="font-size:13px; color:#666">
                            ${activeStaff.join(', ')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    $list.html(html);
}

function renderStatistics() {
    const $stats = $("#statsGrid");
    const totalDays = new Date(currentYear, currentMonth + 1, 0).getDate();
    
    // Calculate statistics
    const staffData = staff.map(s => ({
        name: s.name,
        stats: distributionSystem.staffStats[s.name]
    }));
    
    const totalOffs = staffData.reduce((sum, s) => sum + s.stats.totalOffs, 0);
    const totalStock = staffData.reduce((sum, s) => sum + s.stats.stockDuties, 0);
    const avgOffs = (totalOffs / staff.length).toFixed(1);
    const avgStock = (totalStock / staff.length).toFixed(1);
    
    // Find extremes
    const sortedByOffs = [...staffData].sort((a, b) => b.stats.totalOffs - a.stats.totalOffs);
    const sortedByStock = [...staffData].sort((a, b) => b.stats.stockDuties - a.stats.stockDuties);
    
    const mostOffs = sortedByOffs[0];
    const leastOffs = sortedByOffs[staffData.length - 1];
    const mostStock = sortedByStock[0];
    
    $stats.html(`
        <div class="stat-card">
            <div class="stat-title">Monthly Overview</div>
            <div class="stat-value">${totalOffs} Off Days</div>
            <div class="stat-details">
                ${totalStock} stock duties assigned<br>
                Average: ${avgOffs} offs per staff
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-title">Most Off Days</div>
            <div class="stat-value" style="color:#ff6b6b">${mostOffs.name}</div>
            <div class="stat-details">
                ${mostOffs.stats.totalOffs} off days<br>
                ${mostOffs.stats.sundayOffs} Sunday(s)
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-title">Least Off Days</div>
            <div class="stat-value" style="color:#4CAF50">${leastOffs.name}</div>
            <div class="stat-details">
                ${leastOffs.stats.totalOffs} off days<br>
                ${leastOffs.stats.sundayOffs} Sunday(s)
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-title">Most Stock Duties</div>
            <div class="stat-value" style="color:#1565c0">${mostStock.name}</div>
            <div class="stat-details">
                ${mostStock.stats.stockDuties} duties<br>
                Average: ${avgStock} per staff
            </div>
        </div>
    `);
}

function renderFairnessMetrics() {
    const $metrics = $("#fairnessMetrics");
    
    const staffData = staff.map(s => ({
        name: s.name,
        offs: distributionSystem.staffStats[s.name].totalOffs,
        stock: distributionSystem.staffStats[s.name].stockDuties
    }));
    
    // Calculate fairness scores
    const avgOffs = staffData.reduce((sum, s) => sum + s.offs, 0) / staffData.length;
    const avgStock = staffData.reduce((sum, s) => sum + s.stock, 0) / staffData.length;
    
    const offVariance = staffData.reduce((sum, s) => {
        return sum + Math.pow(s.offs - avgOffs, 2);
    }, 0) / staffData.length;
    
    const stockVariance = staffData.reduce((sum, s) => {
        return sum + Math.pow(s.stock - avgStock, 2);
    }, 0) / staffData.length;
    
    // Fairness percentage (100% = perfect)
    const offFairness = Math.max(0, 100 - (Math.sqrt(offVariance) / avgOffs * 100));
    const stockFairness = Math.max(0, 100 - (Math.sqrt(stockVariance) / avgStock * 100));
    const overallFairness = (offFairness + stockFairness) / 2;
    
    // Determine rating
    let rating = "Excellent";
    let ratingColor = "#4CAF50";
    if (overallFairness < 70) {
        rating = "Needs Improvement";
        ratingColor = "#f44336";
    } else if (overallFairness < 85) {
        rating = "Good";
        ratingColor = "#FF9800";
    } else if (overallFairness < 95) {
        rating = "Very Good";
        ratingColor = "#2196F3";
    }
    
    $metrics.html(`
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-title">Overall Fairness Score</div>
                <div class="stat-value" style="color:${ratingColor}">${overallFairness.toFixed(1)}%</div>
                <div class="stat-details">${rating} distribution</div>
                <div class="fairness-meter">
                    <div class="fairness-fill" style="width:${overallFairness}%; background:${ratingColor}"></div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-title">Off Days Fairness</div>
                <div class="stat-value">${offFairness.toFixed(1)}%</div>
                <div class="stat-details">Average: ${avgOffs.toFixed(1)} offs per staff</div>
                <div class="fairness-meter">
                    <div class="fairness-fill" style="width:${offFairness}%"></div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-title">Stock Duties Fairness</div>
                <div class="stat-value">${stockFairness.toFixed(1)}%</div>
                <div class="stat-details">Average: ${avgStock.toFixed(1)} duties per staff</div>
                <div class="fairness-meter">
                    <div class="fairness-fill" style="width:${stockFairness}%"></div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-title">Distribution Range</div>
                <div class="stat-value">
                    ${Math.min(...staffData.map(s => s.offs))}-${Math.max(...staffData.map(s => s.offs))}
                </div>
                <div class="stat-details">
                    Off days range<br>
                    Stock: ${Math.min(...staffData.map(s => s.stock))}-${Math.max(...staffData.map(s => s.stock))}
                </div>
            </div>
        </div>
        
        <div style="margin-top:30px; background:white; border-radius:15px; padding:25px; box-shadow:0 5px 20px rgba(0,0,0,0.1)">
            <h4 style="margin-top:0; color:#2c3e50">Staff Distribution Analysis</h4>
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:15px">
                ${staffData.map(s => {
                    const offDeviation = ((s.offs - avgOffs) / avgOffs * 100).toFixed(1);
                    const stockDeviation = ((s.stock - avgStock) / avgStock * 100).toFixed(1);
                    const offColor = Math.abs(offDeviation) > 25 ? '#ff6b6b' : Math.abs(offDeviation) > 15 ? '#FF9800' : '#4CAF50';
                    const stockColor = Math.abs(stockDeviation) > 25 ? '#ff6b6b' : Math.abs(stockDeviation) > 15 ? '#FF9800' : '#1565c0';
                    
                    return `
                        <div style="padding:15px; background:#f8f9fa; border-radius:10px; border-left:4px solid ${offColor}">
                            <div style="font-weight:600; color:#2c3e50; margin-bottom:10px">${s.name}</div>
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                                <span style="color:#666">Offs:</span>
                                <span style="font-weight:600; color:${offColor}">${s.offs} (${offDeviation}%)</span>
                            </div>
                            <div style="display:flex; justify-content:space-between">
                                <span style="color:#666">Stock:</span>
                                <span style="font-weight:600; color:${stockColor}">${s.stock} (${stockDeviation}%)</span>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `);
}

let offsChart = null, stockChart = null, workloadChart = null;

function renderCharts() {
    // Clean up existing charts
    [offsChart, stockChart, workloadChart].forEach(chart => {
        if (chart) chart.destroy();
    });
    
    const ctx1 = document.getElementById('offsChart').getContext('2d');
    const ctx2 = document.getElementById('stockChart').getContext('2d');
    const ctx3 = document.getElementById('workloadChart').getContext('2d');
    
    const staffNames = staff.map(s => s.name);
    const offsData = staff.map(s => distributionSystem.staffStats[s.name].totalOffs);
    const sundayOffsData = staff.map(s => distributionSystem.staffStats[s.name].sundayOffs);
    const stockData = staff.map(s => distributionSystem.staffStats[s.name].stockDuties);
    const workData = staff.map(s => distributionSystem.staffStats[s.name].workingDays);
    
    const avgOffs = offsData.reduce((a, b) => a + b, 0) / offsData.length;
    
    // Offs Distribution Chart
    offsChart = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: staffNames,
            datasets: [
                {
                    label: 'Total Offs',
                    data: offsData,
                    backgroundColor: '#ff6b6b',
                    borderColor: '#d32f2f',
                    borderWidth: 1
                },
                {
                    label: 'Sunday Offs',
                    data: sundayOffsData,
                    backgroundColor: '#FF9800',
                    borderColor: '#f57c00',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'üìÖ Off Days Distribution',
                    font: { size: 16 }
                },
                legend: { position: 'top' }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 },
                    title: {
                        display: true,
                        text: 'Number of Offs'
                    }
                }
            }
        }
    });
    
    // Stock Duties Chart
    stockChart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: staffNames,
            datasets: [{
                data: stockData,
                backgroundColor: [
                    '#667eea', '#764ba2', '#4CAF50', '#FF9800',
                    '#2196F3', '#f44336', '#9C27B0', '#009688'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'üì¶ Stock Duties Distribution',
                    font: { size: 16 }
                },
                legend: {
                    position: 'right',
                    labels: { padding: 20 }
                }
            }
        }
    });
    
    // Workload Chart
    workloadChart = new Chart(ctx3, {
        type: 'radar',
        data: {
            labels: staffNames,
            datasets: [
                {
                    label: 'Working Days',
                    data: workData,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2
                },
                {
                    label: 'Stock Duties',
                    data: stockData,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: '‚öñÔ∏è Workload Balance',
                    font: { size: 16 }
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    ticks: { stepSize: 2 }
                }
            }
        }
    });
}

function renderPerformanceReport() {
    const $report = $("#performanceReport");
    
    const staffData = staff.map(s => ({
        name: s.name,
        role: s.role,
        ...distributionSystem.staffStats[s.name]
    }));
    
    const avgOffs = staffData.reduce((sum, s) => sum + s.totalOffs, 0) / staffData.length;
    const avgStock = staffData.reduce((sum, s) => sum + s.stockDuties, 0) / staffData.length;
    
    let html = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>Staff Member</th>
                    <th>Role</th>
                    <th>Total Offs</th>
                    <th>Sunday Offs</th>
                    <th>Stock Duties</th>
                    <th>Working Days</th>
                    <th>Balance Score</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    staffData.forEach(s => {
        const offDeviation = ((s.totalOffs - avgOffs) / avgOffs * 100).toFixed(1);
        const stockDeviation = ((s.stockDuties - avgStock) / avgStock * 100).toFixed(1);
        const balanceScore = 100 - (Math.abs(parseFloat(offDeviation)) + Math.abs(parseFloat(stockDeviation))) / 2;
        
        let status = "‚úÖ Balanced";
        let statusColor = "#4CAF50";
        let statusIcon = "‚úÖ";
        
        if (balanceScore < 70) {
            status = "‚ö†Ô∏è Unbalanced";
            statusColor = "#f44336";
            statusIcon = "‚ö†Ô∏è";
        } else if (balanceScore < 85) {
            status = "‚ö†Ô∏è Needs Attention";
            statusColor = "#FF9800";
            statusIcon = "‚ö†Ô∏è";
        }
        
        html += `
            <tr>
                <td><strong>${s.name}</strong></td>
                <td>${s.role}</td>
                <td style="font-weight:600; color:#${s.totalOffs >= 3 && s.totalOffs <= 4 ? '4CAF50' : 'f44336'}">
                    ${s.totalOffs}
                    ${s.totalOffs >= 3 && s.totalOffs <= 4 ? '‚úÖ' : '‚ùå'}
                </td>
                <td>${s.sundayOffs}</td>
                <td style="color:#1565c0; font-weight:600">${s.stockDuties}</td>
                <td>${s.workingDays}</td>
                <td style="background:${balanceScore >= 85 ? '#e8f5e9' : balanceScore >= 70 ? '#fff3e0' : '#ffebee'};
                   color:${balanceScore >= 85 ? '#2e7d32' : balanceScore >= 70 ? '#f57c00' : '#c62828'};
                   font-weight:600">
                    ${balanceScore.toFixed(1)}%
                </td>
                <td style="color:${statusColor}; font-weight:600">
                    ${statusIcon} ${status}
                </td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
        
        <div style="margin-top:30px; background:linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius:15px; padding:25px;">
            <h4 style="margin-top:0; color:#2c3e50">üìã Monthly Summary</h4>
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:20px;">
                <div style="padding:15px; background:white; border-radius:10px; text-align:center">
                    <div style="font-size:12px; color:#666; margin-bottom:5px">Average Offs per Staff</div>
                    <div style="font-size:28px; font-weight:700; color:#4CAF50">${avgOffs.toFixed(1)}</div>
                    <div style="font-size:12px; color:#666">Target: 3-4 offs</div>
                </div>
                <div style="padding:15px; background:white; border-radius:10px; text-align:center">
                    <div style="font-size:12px; color:#666; margin-bottom:5px">Average Stock Duties</div>
                    <div style="font-size:28px; font-weight:700; color:#1565c0">${avgStock.toFixed(1)}</div>
                    <div style="font-size:12px; color:#666">Fairly distributed</div>
                </div>
                <div style="padding:15px; background:white; border-radius:10px; text-align:center">
                    <div style="font-size:12px; color:#666; margin-bottom:5px">Staff Meeting Target</div>
                    <div style="font-size:28px; font-weight:700; color:#4CAF50">
                        ${staffData.filter(s => s.totalOffs >= 3 && s.totalOffs <= 4).length}/${staff.length}
                    </div>
                    <div style="font-size:12px; color:#666">3-4 offs per month</div>
                </div>
                <div style="padding:15px; background:white; border-radius:10px; text-align:center">
                    <div style="font-size:12px; color:#666; margin-bottom:5px">Overall Fairness</div>
                    <div style="font-size:28px; font-weight:700; color:#667eea">
                        ${((staffData.reduce((sum, s) => {
                            const offDev = Math.abs((s.totalOffs - avgOffs) / avgOffs * 100);
                            const stockDev = Math.abs((s.stockDuties - avgStock) / avgStock * 100);
                            return sum + (100 - (offDev + stockDev) / 2);
                        }, 0) / staffData.length)).toFixed(1)}%
                    </div>
                    <div style="font-size:12px; color:#666">Higher is better</div>
                </div>
            </div>
        </div>
    `;
    
    $report.html(html);
}

// ====== VIEW CONTROLS ======
function switchView(view) {
    currentView = view;
    
    // Update active button
    $(".view-btn").removeClass("active");
    $(`.view-btn[data-view="${view}"]`).addClass("active");
    
    // Show/hide views
    if (view === 'calendar') {
        $("#calendar").show();
        $("#listView").hide();
    } else {
        $("#calendar").hide();
        $("#listView").show();
        renderListView();
    }
}

// ====== EXPORT FUNCTIONS ======
function exportToCSV() {
    let csv = 'Staff Name,Role,Total Offs,Sunday Offs,Stock Duties,Working Days,Off Deviation %,Stock Deviation %,Balance Score,Status\n';
    
    const staffData = staff.map(s => ({
        name: s.name,
        role: s.role,
        ...distributionSystem.staffStats[s.name]
    }));
    
    const avgOffs = staffData.reduce((sum, s) => sum + s.totalOffs, 0) / staffData.length;
    const avgStock = staffData.reduce((sum, s) => sum + s.stockDuties, 0) / staffData.length;
    
    staffData.forEach(s => {
        const offDeviation = ((s.totalOffs - avgOffs) / avgOffs * 100).toFixed(2);
        const stockDeviation = ((s.stockDuties - avgStock) / avgStock * 100).toFixed(2);
        const balanceScore = 100 - (Math.abs(parseFloat(offDeviation)) + Math.abs(parseFloat(stockDeviation))) / 2;
        const status = balanceScore >= 85 ? 'Balanced' : balanceScore >= 70 ? 'Needs Attention' : 'Unbalanced';
        
        csv += `"${s.name}","${s.role}",${s.totalOffs},${s.sundayOffs},${s.stockDuties},${s.workingDays},${offDeviation},${stockDeviation},${balanceScore.toFixed(2)},"${status}"\n`;
    });
    
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Staff_Performance_${months[currentMonth]}_${currentYear}.csv`;
    link.click();
}

function exportToPDF() {
    alert('For detailed PDF reports, use the print function (Ctrl+P) and save as PDF.');
}

// ====== INITIALIZATION ======
function initializeMonthTabs() {
    const $tabs = $("#tabs");
    $tabs.empty();
    
    months.forEach((m, i) => {
        $tabs.append(`<div class="tab" data-month="${i}">${m}</div>`);
    });
}

function initializeFilters() {
    const $staffFilter = $("#filterStaff");
    const $monthFilter = $("#filterMonth");
    
    // Staff filter
    $staffFilter.empty();
    $staffFilter.append('<option value="">All Staff Members</option>');
    staff.forEach(s => {
        $staffFilter.append(`<option value="${s.name}">${s.name}</option>`);
    });
    
    // Month filter
    $monthFilter.empty();
    $monthFilter.append('<option value="">Filter by Month</option>');
    months.forEach((m, i) => {
        $monthFilter.append(`<option value="${i}">${m}</option>`);
    });
}

function renderMonth(month) {
    currentMonth = month;
    
    if (currentView === 'calendar') {
        renderCalendar(month);
        $("#calendar").show();
        $("#listView").hide();
    } else {
        $("#calendar").hide();
        $("#listView").show();
        renderListView();
    }
}

// ====== EVENT LISTENERS ======
$(document).ready(function() {
    // Initialize UI
    initializeMonthTabs();
    initializeFilters();
    
    // Tab click handler
    $("#tabs").on("click", ".tab", function() {
        $(".tab").removeClass("active");
        $(this).addClass("active");
        const month = $(this).data("month");
        renderMonth(month);
    });
    
    // View switch handler
    $(".view-btn").click(function() {
        const view = $(this).data("view");
        switchView(view);
    });
    
    // Filter handlers
    $("#filterStaff").change(function() {
        const selected = $(this).val();
        if (selected) {
            alert(`Filter by ${selected} - This feature requires additional implementation.`);
        }
    });
    
    $("#filterMonth").change(function() {
        const month = $(this).val();
        if (month !== "") {
            renderMonth(parseInt(month));
        }
    });
    
    // Start with current month
    const currentDate = new Date();
    if (currentDate.getFullYear() === currentYear) {
        $(".tab").eq(currentDate.getMonth()).addClass("active");
        renderMonth(currentDate.getMonth());
    } else {
        $(".tab").eq(0).addClass("active");
        renderMonth(0);
    }
});
</script>
</body>
</html>